<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ぷにぷに風ゲーム</title>
    <style>
        body { text-align: center; margin: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; }
        #gameCanvas { border: 1px solid black; max-width: 100%; height: auto; }
        .timer { font-size: 1.5rem; margin-top: 10px; }
        #scoreboard { display: none; }
        .highlight { animation: blink 1s linear infinite; }
        @keyframes blink { 50% { opacity: 0; } }
        #restartButton { font-size: 1rem; padding: 0.5rem 1rem; margin-top: 15px; }
    </style>
</head>
<body>
    <h1>ぷにぷに風ゲーム</h1>
    <canvas id="gameCanvas" width="500" height="500"></canvas>
    <div class="timer">Time: <span id="timer">0</span>s</div>
    <button id="restartButton" onclick="startNewGame()">リスタート</button>

    <!-- 得点画面 -->
    <div id="scoreboard">
        <h2>ランキング</h2>
        <div id="ranking"></div>
        <button onclick="startNewGame()">新しいゲームをスタート</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.17.1/matter.min.js"></script>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const colors = ['red', 'blue', 'green', 'yellow'];
        
        // 色ごとの摩擦係数を設定
        const frictionMap = {
            'red': 0.05,
            'blue': 0.1,
            'green': 0.2,
            'yellow': 0.3
        };

        let balls = [];
        const radius = 20;
        const distanceThreshold = radius * 2 + 3;  // 直径+3ピクセルの距離
        let timeElapsed = 0;
        let gameOver = false;
        let ranking = [];
        let timerInterval = null;
        let animationFrameId = null;
        let addBallInterval = null; // 5秒ごとのボール追加インターバル

        // タイマーの更新
        function startTimer() {
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if (!gameOver) {
                    timeElapsed++;
                    document.getElementById('timer').textContent = timeElapsed;
                }
            }, 1000);
        }

        // Matter.jsエンジンの作成
        const engine = Matter.Engine.create();
        const world = engine.world;

        // 重力加速度を3倍に設定
        world.gravity.y = 3;

        // 円形領域の設定
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const boundaryRadius = 200;

        // 円形領域の描画
        function drawCircularBoundary() {
            ctx.beginPath();
            ctx.arc(centerX, centerY, boundaryRadius, 0, Math.PI * 2);
            ctx.stroke();
        }

        // ボールを生成
        function createBall(x, y, color) {
            // 色ごとの摩擦係数を設定
            const friction = frictionMap[color];
            const ball = Matter.Bodies.circle(x, y, radius, {
                restitution: 0.8,
                friction: friction,        // 摩擦係数
                frictionStatic: friction,  // 静止摩擦係数
                frictionAir: friction * 0.5, // 空気抵抗として摩擦を適用
                render: { fillStyle: color }
            });
            ball.color = color;
            balls.push(ball);
            Matter.World.add(world, ball);
        }

        // 指定した数のボールをランダムに生成
        function addBalls(count) {
            for (let i = 0; i < count; i++) {
                const angle = Math.random() * Math.PI * 2;
                const r = Math.random() * (boundaryRadius - radius);
                const x = centerX + r * Math.cos(angle);
                const y = centerY + r * Math.sin(angle);
                const color = colors[Math.floor(Math.random() * colors.length)];
                createBall(x, y, color);
            }
        }

        // 初期ボールの配置（20個）
        addBalls(20);

        // 3個以上の連続削除と1個のボール追加
        function checkAndRemoveBalls() {
            const toRemove = [];
            balls.forEach(ball => {
                const connectedBalls = balls.filter(otherBall => {
                    const dx = otherBall.position.x - ball.position.x;
                    const dy = otherBall.position.y - ball.position.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    return otherBall.color === ball.color && distance <= distanceThreshold;
                });

                if (connectedBalls.length >= 3) {
                    toRemove.push(...connectedBalls);
                }
            });

            if (toRemove.length > 0) {
                toRemove.forEach(ball => {
                    Matter.World.remove(world, ball);
                });
                balls = balls.filter(ball => !toRemove.includes(ball));
                addBalls(1);  // 常に1個のボールを追加
            }
        }

        // ゲームオーバー判定
        function checkGameOver() {
            if (balls.length <= 3 && !gameOver) {
                gameOver = true;
                clearInterval(timerInterval);
                clearInterval(addBallInterval);  // 5秒ごとのボール追加停止
                cancelAnimationFrame(animationFrameId);
                displayScoreboard();
            }
        }

        // 得点画面の表示
        function displayScoreboard() {
            const scoreboard = document.getElementById('scoreboard');
            scoreboard.style.display = 'block';
            document.getElementById('gameCanvas').style.display = 'none';
            document.getElementById('restartButton').style.display = 'none';

            // ランキングに追加
            ranking.push({ time: timeElapsed });
            ranking.sort((a, b) => a.time - b.time);  // 時間が少ないほど上位に

            // ランキング表示
            const rankingDiv = document.getElementById('ranking');
            rankingDiv.innerHTML = ranking.map((record, index) =>
                `<p class="${index === ranking.length - 1 ? 'highlight' : ''}">
                    ${index + 1}. 経過時間: ${record.time}秒
                </p>`).join('');
        }

        // 新しいゲームを開始
        function startNewGame() {
            timeElapsed = 0;
            gameOver = false;
            balls.forEach(ball => Matter.World.remove(world, ball));
            balls = [];
            document.getElementById('timer').textContent = timeElapsed;
            document.getElementById('gameCanvas').style.display = 'block';
            document.getElementById('scoreboard').style.display = 'none';
            document.getElementById('restartButton').style.display = 'inline';
            addBalls(20);  // 初期ボール数を20個に設定
            startTimer();
            startAnimation();

            // 5秒ごとの新しいボール追加タイマー
            clearInterval(addBallInterval);
            addBallInterval = setInterval(() => addBalls(1), 5000);
        }

        // Matter.jsの更新ループ
        Matter.Engine.run(engine);

        // 描画ループ
        function startAnimation() {
            function render() {
                if (!gameOver) {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);

                    drawCircularBoundary();

                    balls.forEach(ball => {
                        ctx.beginPath();
                        ctx.arc(ball.position.x, ball.position.y, ball.circleRadius, 0, Math.PI * 2);
                        ctx.fillStyle = ball.color;
                        ctx.fill();
                        ctx.closePath();
                    });

                    checkAndRemoveBalls();
                    checkGameOver();

                    animationFrameId = requestAnimationFrame(render);
                }
            }
            cancelAnimationFrame(animationFrameId);  // 前のアニメーションフレームをキャンセル
            render();
        }

        // デバイスの傾きによって重力方向を変更
        window.addEventListener('deviceorientation', (event) => {
            const { beta, gamma } = event;

            const gravityX = Math.sin(gamma * (Math.PI / 180)) * 3;  // 重力を3倍に設定
            const gravityY = Math.sin(beta * (Math.PI / 180)) * 3;

            world.gravity.x = gravityX;
            world.gravity.y = gravityY;
        });

        // タッチ操作でボールをドラッグ可能に
        canvas.addEventListener('touchstart', (e) => {
            const touch = e.touches[0];
            const x = touch.clientX - canvas.offsetLeft;
            const y = touch.clientY - canvas.offsetTop;

            balls.forEach(ball => {
                const dx = x - ball.position.x;
                const dy = y - ball.position.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                if (distance <= ball.circleRadius) {
                    Matter.Body.setStatic(ball, true);
                    ball.isDragging = true;
                }
            });
        });

        canvas.addEventListener('touchmove', (e) => {
            const touch = e.touches[0];
            const x = touch.clientX - canvas.offsetLeft;
            const y = touch.clientY - canvas.offsetTop;

            balls.forEach(ball => {
                if (ball.isDragging) {
                    Matter.Body.setPosition(ball, { x, y });
                }
            });
            e.preventDefault();
        });

        canvas.addEventListener('touchend', () => {
            balls.forEach(ball => {
                if (ball.isDragging) {
                    Matter.Body.setStatic(ball, false);
                    ball.isDragging = false;
                }
            });
        });

        // 円形の境界にボールが入るよう制約を加える
        Matter.Events.on(engine, 'beforeUpdate', () => {
            balls.forEach(ball => {
                const dx = ball.position.x - centerX;
                const dy = ball.position.y - centerY;
                const distance = Math.sqrt(dx * dx + dy * dy);

                if (distance > boundaryRadius - ball.circleRadius) {
                    const angle = Math.atan2(dy, dx);
                    Matter.Body.setPosition(ball, {
                        x: centerX + (boundaryRadius - ball.circleRadius) * Math.cos(angle),
                        y: centerY + (boundaryRadius - ball.circleRadius) * Math.sin(angle)
                    });
                }
            });
        });

        // 初回のタイマーとアニメーションをスタート
        startTimer();
        startAnimation();
        
        // 5秒ごとの新しいボール追加タイマー
        addBallInterval = setInterval(() => addBalls(1), 5000);
    </script>
</body>
</html>

