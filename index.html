<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ぷにぷに風ゲーム</title>
    <style>
        body { text-align: center; }
        #gameCanvas { border: 1px solid black; width: 500px; height: 500px; }
        .score { font-size: 20px; margin: 10px; }
    </style>
</head>
<body>
    <h1>ぷにぷに風ゲーム</h1>
    <canvas id="gameCanvas" width="500" height="500"></canvas>
    <div class="score">Score: <span id="score">0</span></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.17.1/matter.min.js"></script>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const colors = ['red', 'blue', 'green', 'yellow'];
        const balls = [];
        const radius = 20;
        const growTime = 3000;  // 3秒以上接触で合体
        let score = 0;

        // Matter.jsエンジンの作成
        const engine = Matter.Engine.create();
        const world = engine.world;

        // 円形領域の設定
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const boundaryRadius = 200;

        // 円形領域の描画
        function drawCircularBoundary() {
            ctx.beginPath();
            ctx.arc(centerX, centerY, boundaryRadius, 0, Math.PI * 2);
            ctx.stroke();
        }

        // ボールを生成
        function createBall(x, y, color) {
            const ball = Matter.Bodies.circle(x, y, radius, {
                restitution: 0.8,
                render: { fillStyle: color }
            });
            ball.color = color;
            ball.touching = {};
            balls.push(ball);
            Matter.World.add(world, ball);
        }

        // 初期ボールの配置
        for (let i = 0; i < 10; i++) {
            const angle = Math.random() * Math.PI * 2;
            const r = Math.random() * (boundaryRadius - radius);
            const x = centerX + r * Math.cos(angle);
            const y = centerY + r * Math.sin(angle);
            const color = colors[Math.floor(Math.random() * colors.length)];
            createBall(x, y, color);
        }

        // 合体処理：3秒以上接触した同色ボールを一つの大きなボールにする
        function checkAndCombineBalls() {
            balls.forEach(ball => {
                balls.forEach(otherBall => {
                    if (ball !== otherBall && ball.color === otherBall.color) {
                        const collision = Matter.SAT.collides(ball, otherBall);
                        if (collision.collided) {
                            if (!ball.touching[otherBall.id]) {
                                ball.touching[otherBall.id] = Date.now();
                            }
                            const elapsedTime = Date.now() - ball.touching[otherBall.id];
                            if (elapsedTime >= growTime) {
                                // 2つのボールを合体
                                const newRadius = Math.sqrt(Math.pow(ball.circleRadius, 2) + Math.pow(otherBall.circleRadius, 2));
                                const newX = (ball.position.x + otherBall.position.x) / 2;
                                const newY = (ball.position.y + otherBall.position.y) / 2;

                                // 新しい大きなボールを作成
                                const combinedBall = Matter.Bodies.circle(newX, newY, newRadius, {
                                    restitution: 0.8,
                                    render: { fillStyle: ball.color }
                                });
                                combinedBall.color = ball.color;

                                // 元のボールを削除し、新しいボールを追加
                                Matter.World.remove(world, ball);
                                Matter.World.remove(world, otherBall);
                                balls.splice(balls.indexOf(ball), 1);
                                balls.splice(balls.indexOf(otherBall), 1);
                                balls.push(combinedBall);
                                Matter.World.add(world, combinedBall);
                            }
                        } else {
                            ball.touching[otherBall.id] = null;
                        }
                    }
                });
            });
        }

        // 新しいランダムな色のボールを3秒ごとに追加
        setInterval(() => {
            const angle = Math.random() * Math.PI * 2;
            const r = Math.random() * (boundaryRadius - radius);
            const x = centerX + r * Math.cos(angle);
            const y = centerY + r * Math.sin(angle);
            const color = colors[Math.floor(Math.random() * colors.length)];
            createBall(x, y, color);
        }, 3000);

        // Matter.jsの更新ループ
        Matter.Engine.run(engine);

        // 描画ループ
        (function render() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            drawCircularBoundary();

            balls.forEach(ball => {
                ctx.beginPath();
                ctx.arc(ball.position.x, ball.position.y, ball.circleRadius, 0, Math.PI * 2);
                ctx.fillStyle = ball.color;
                ctx.fill();
                ctx.closePath();
            });

            checkAndCombineBalls();

            requestAnimationFrame(render);
        })();

        // デバイスの傾きによって重力方向を変更
        window.addEventListener('deviceorientation', (event) => {
            const { beta, gamma } = event;

            const gravityX = Math.sin(gamma * (Math.PI / 180));
            const gravityY = Math.sin(beta * (Math.PI / 180));

            world.gravity.x = gravityX;
            world.gravity.y = gravityY;
        });

        // タッチ操作でボールをドラッグ可能に
        canvas.addEventListener('touchstart', (e) => {
            const touch = e.touches[0];
            const x = touch.clientX - canvas.offsetLeft;
            const y = touch.clientY - canvas.offsetTop;

            balls.forEach(ball => {
                const dx = x - ball.position.x;
                const dy = y - ball.position.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                if (distance <= ball.circleRadius) {
                    Matter.Body.setStatic(ball, true);
                    ball.isDragging = true;
                }
            });
        });

        canvas.addEventListener('touchmove', (e) => {
            const touch = e.touches[0];
            const x = touch.clientX - canvas.offsetLeft;
            const y = touch.clientY - canvas.offsetTop;

            balls.forEach(ball => {
                if (ball.isDragging) {
                    Matter.Body.setPosition(ball, { x, y });
                }
            });
            e.preventDefault();
        });

        canvas.addEventListener('touchend', () => {
            balls.forEach(ball => {
                if (ball.isDragging) {
                    Matter.Body.setStatic(ball, false);
                    ball.isDragging = false;
                }
            });
        });

        // 円形の境界にボールが入るよう制約を加える
        Matter.Events.on(engine, 'beforeUpdate', () => {
            balls.forEach(ball => {
                const dx = ball.position.x - centerX;
                const dy = ball.position.y - centerY;
                const distance = Math.sqrt(dx * dx + dy * dy);

                if (distance > boundaryRadius - ball.circleRadius) {
                    const angle = Math.atan2(dy, dx);
                    Matter.Body.setPosition(ball, {
                        x: centerX + (boundaryRadius - ball.circleRadius) * Math.cos(angle),
                        y: centerY + (boundaryRadius - ball.circleRadius) * Math.sin(angle)
                    });
                }
            });
        });
    </script>
</body>
</html>
